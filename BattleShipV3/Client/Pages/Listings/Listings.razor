@page "/listingslist"

@using BattleShipV3.Client.DesignPatterns.Decorator
@using BattleShipV3.Client.DesignPatterns.Observer
@using BattleShipV3.Client.DesignPatterns.Singleton
@using BattleShipV3.Client.DesignPatterns.Strategy
@using BattleShipV3.Shared
@using BattleShipV3.Shared.Data.Commands.Listing.Create
@using BattleShipV3.Shared.Data.Commands.Listing.Update
@using Microsoft.AspNetCore.SignalR.Client
@using MudBlazor
@using Models
@using MudBlazor.ThemeManager

@inject ToastService toastService
@inject NavigationManager Navigation
@inject ListingService listingService


@implements IAsyncDisposable

<MudText>
    Online users: @onlineUsers
</MudText>

<MudSelect T="string" Label="Filter strategy" AnchorOrigin="Origin.BottomCenter" ValueChanged="value => SetStrategy(value)" >
    <MudSelectItem Value="@("By Lobby Name")" />
    <MudSelectItem Value="@("By Creator")" />
    <MudSelectItem Value="@("Max Elo Less Than")" />
    <MudSelectItem Value="@("Max Elo More Than")" />
</MudSelect>

@if(Global.CurrentUser != null)
{
    <MudText>You are logged in as @($"{Global.CurrentUser?.Name}")</MudText>
}

<MudButton Color="Color.Secondary" Variant="Variant.Filled" @onclick="ToggleLobbyCreate" Style="margin:5px">Create a Lobby</MudButton>

<MudButton Color="Color.Secondary" Variant="Variant.Filled" @onclick="JoinLobby" Disabled="selectedListing == null
                || selectedListing.PlayerOne.Id == Global.CurrentUser.Id || selectedListing.PlayerTwo?.Id == Global.CurrentUser.Id" Style="margin:5px">Join a Lobby</MudButton>

@if(isLobbyCreatePopUpOpen)
{
     <MudPopover Open="@isLobbyCreatePopUpOpen" Fixed="true" Class="px-4 pt-4">
        <div class="d-flex flex-column">
            <MudText>Create a Lobby</MudText>
            <MudText>Lobby Name:</MudText>
            <MudInputString @bind-Value="lobbyName"></MudInputString>
            <MudText>Minimum elo</MudText>
            <MudNumericField @bind-Value="eloFrom"></MudNumericField>
            <MudText>Maximum elo</MudText>
            <MudNumericField @bind-Value="eloTo"></MudNumericField>
            <MudButton OnClick="@CreateDecoratedLobby" Class="ml-auto mr-n3 mb-1" Disabled="@(lobbyName == null || lobbyName.Length < 3)" Color="Color.Success">Create</MudButton>
            <MudButton OnClick="@ToggleLobbyCreate" Class="ml-auto mr-n3 mb-1" Color="Color.Error">Close</MudButton>
        </div>
</MudPopover>
}


<MudTable Items="@listings" Hover="true" Striped="true" Filter="new Func<Listing,bool>(FilterFunc1)" @bind-SelectedItem="selectedListing">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Match Listings</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Players</MudTh>
        <MudTh>@(">=")</MudTh>
        <MudTh>@("<")</MudTh>
        <MudTh>Name</MudTh>
        <MudTh>Creator</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Players">@($"{GetLobbySize(context)}/2")</MudTd>
        <MudTd DataLabel=">=">@context.EloFrom</MudTd>
        <MudTd DataLabel="<">@context.EloTo</MudTd>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Creator">@context.PlayerOne.Name</MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>

</MudTable>


<div class="d-flex flex-wrap mt-4">
    <div style="min-width:200px;">
        <MudText Inline="true" Class="align-self-center">Selected: @selectedListing?.Name</MudText>
    </div>
</div>
